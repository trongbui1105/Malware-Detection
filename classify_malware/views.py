from django.shortcuts import render
import ember
import lightgbm as lgb
from classify_malware.VTService import VTService

# Create your views here.
def index(request):
    return render(request, "index.html")

def classify(file):
    vt_service = VTService()
    vt_api_keys = [
        "1940811bdf9a9450755939a5acab4a420104e74e546677fdd03f8ff0bb4f3a6e",
    ]
    response = vt_service.fetch_engine_values(file, vt_api_keys[0])
    return response

def predict(request):
    file_name = ''
    lst_result = []
    type_of_malware = []
    if request.method == "POST" and request.FILES['file']:
        uploaded_file = request.FILES['file'].read()
        lgbm_model = lgb.Booster(model_file="ember/data/ember2018/ember_model_2018.txt")
        file_name = request.FILES['file'].name
        lst_result = ember.predict_sample(lgbm_model, uploaded_file)
        print(lst_result[0])
        type_of_malware = classify(lst_result[1])
    context = {
        'prediction_score': lst_result[0],
        'file_name': file_name,
        'file_sha256': lst_result[1],
        'type_of_malware': type_of_malware
    }
    return render(request, 'result.html', context)