from VTService import VTService
import time
import csv
from openpyxl import workbook
from openpyxl import load_workbook


vt_service = VTService()


# vt_api_keys = [
#     # "89d7adbec737f48918eb7b3548ea88e52c567d39bd207c8a271e2a84329dae81",
#     # "76ebd939301445249b9dfd7bb58e8be4d85f572de382cd6eceeb4a56ad7587f6",
#     # "583680f214840a461ead2cec8fae769c1eb3ee5461e362455e0d6daf38be12db",
#     # "02e4d9d35863b2c2e057289311bbd37f2eb21a7dd2496a04d298b3e680de2fd5",
#     # "a2db6727abaf1f4908d2d422c15371d25c9bc7debdc0fd23a4f50426d24e5a96",
#     # "ab8421085f362f075cc88cb1468534253239be0bc482da052d8785d422aaabd7",
#     # "ac6f89d4a5f58fa8d539d0e07de38d4f73012954348123d5cfdaa63f503ad706",
#     # "72b066aa76a58a2a29e0bc58fb85271e9a4222c552ecf97701f8526edd49670f",
#     # "d92949f61388b91e18c5c75a0c668e7cc512039b719d2d5523266e843982a599",
#     # "7d0967f369b915aceec2b784c7d425f6c113e0b2713d4c221e78d9b507e9eeb7",
#     # "6d179b22ca63010c75c01e0df2e6f2b5492b1b17d61fd036498b8c65a14e5c3f",
#     # "a2114d52e027e3cbe908f75eef6343e2210918cd348e360d9ba523f52ae6a227",
#     # "35008f6f8c59a23e388fea8128618bb3ceb17b6b3b34003dbdb6025d44c31819",
#     # "0202c928cb410a25b09b6c635aab89b86fed89446c7f34d8167985bdcdda17a4",
#     "ad79513a30bcc0d6cf8605853487fa699b73f8e9acf2b8d3ff5263e64c365241",
#     # "c6d03879e310810c13423bf8008fd03905a7c6d062db6264fcc6c439f5b54c59",
#     # "6bbb6c6aa0faeb364e29750368e388a5660042df96789ecb51e0989108a29296",
#     # "92a48899c09bd68fa5496d77d39573dd4419b8779473de5514634b6ca04de33c",
#     "e522776509703ab74c161038d60c27e97487c87cee0182a6a5e32e97211b071c",
#     "4bd38abec9c45954138d8a1d14036c881ed6448c94d3b6fa092e7b6582105cdc",
#     "1940811bdf9a9450755939a5acab4a420104e74e546677fdd03f8ff0bb4f3a6e",
#     "995ed30f55caa1bebf877354a5e3312b3c50e32bd20669aca72ae927b829d7f2",
#     "e504ea147bda86a560a0a869fcb39a17b21741d787e3429319b72bbf4225e560",
#     # "c29a56053a9da5332533817828b1948538ca4004e60338be895056b953bf38ee",
#     "446fa3cb8d71c5ab44c750c02e8b8864f993a0c932bc91a736fd6c8ebf74338a"
# ]
vt_api_keys = [
    "1940811bdf9a9450755939a5acab4a420104e74e546677fdd03f8ff0bb4f3a6e",
    "995ed30f55caa1bebf877354a5e3312b3c50e32bd20669aca72ae927b829d7f2",
    "e504ea147bda86a560a0a869fcb39a17b21741d787e3429319b72bbf4225e560"
]





index = 0

vt_api_key_index = 0


# with open('src/utility/source/metadata.csv', mode='r') as csv_file:
#     csv_reader = csv.DictReader(csv_file)
#     for row in csv_reader:
#         # vt_result_file = open("src/utility/destination/malware_vt_result/vt_result.txt", "a+")
#         vt_result_file = open('src/utility/source/metadata.csv', mode='a+')
#         if row['label'] == '0':
#             # print('Benign')
#             continue
#         else:
#             vt_api_key = vt_api_keys[0]
#             response = vt_service.fetch_engine_values(row['sha256'].strip(), vt_api_key)
#             print(str(time.strftime("%H-%M-%S")) + ": " + str(index) + ": " + vt_api_key + ": " + response)

#             try:
#                 vt_result_file.write(response + "\n")
#             except Exception as e:
#                 vt_result_file.write("Error\n")
#                 print(e)

#             time.sleep(0.5)

with open('src/utility/source/metadata.csv', mode='r') as csv_file:
    csv_reader = csv.DictReader(csv_file)

    for row in csv_reader:
        vt_result_file = open("src/utility/destination/malware_vt_result/vt_result.txt", "a+")
        # vt_result_file = open('src/utility/source/metadata.csv', mode='w')
        if row['label'] == '0':
            response = ''
        else:
            index = index + 1
            vt_api_key = vt_api_keys[vt_api_key_index]
            response = vt_service.fetch_engine_values(row['sha256'].strip(), vt_api_key)
            print(str(time.strftime("%H-%M-%S")) + ": " + str(index) + ": " + vt_api_key + ": " + response)
        vt_api_key_index = vt_api_key_index + 1

        if vt_api_key_index == len(vt_api_keys):
            vt_api_key_index = 0
        text = row[''] + "," + row['sha256'] + "," + row['appeared'] + "," + row['label'] + "," + response + "," + row['subset']
        try:
            vt_result_file.write(text + "\n")
        except Exception as e:
            vt_result_file.write("Error\n")
            print(e)

        time.sleep(0.5)
            # break

vt_result_file.close()

